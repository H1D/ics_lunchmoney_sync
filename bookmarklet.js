javascript: (()=>{(async()=>{document.getElementById("tw-cdn")||await new Promise(e=>{const s=Object.assign(document.createElement("script"),{id:"tw-cdn",src:"https://cdn.tailwindcss.com",onload:e});document.head.append(s)});const Y=(e,s)=>{const a=document.createElement("dialog");a.className="backdrop:bg-black/50 bg-white rounded-xl p-6 max-w-md w-[90%] shadow-2xl";const f=Object.assign(document.createElement("h2"),{textContent:e,className:"mb-4 text-xl font-semibold text-red-600"}),u=Object.assign(document.createElement("div"),{innerHTML:s,className:"mb-5 text-sm leading-relaxed text-gray-600"}),p=Object.assign(document.createElement("button"),{textContent:"Close",className:"bg-gray-500 hover:bg-gray-600 text-white px-5 py-2.5 rounded-lg text-sm font-medium transition",onclick:()=>{a.close(),a.remove()}}),l=Object.assign(document.createElement("div"),{className:"flex gap-3 justify-end"});l.append(p),a.append(f,u,l),document.body.append(a),a.showModal(),a.addEventListener("cancel",t=>{t.preventDefault(),a.close(),a.remove()})},U=e=>{const s=Object.assign(document.createElement("div"),{textContent:e,className:"fixed bottom-5 right-5 px-5 py-3 bg-gray-800 text-white rounded-lg z-[9999]"});document.body.append(s),setTimeout(()=>s.remove(),1e4)},m=e=>new Intl.DateTimeFormat("sv-SE").format(e),K=()=>new Promise(e=>{const s={token:localStorage.getItem("LUNCHMONEY_TOKEN")||"",assetId:localStorage.getItem("LUNCHMONEY_ASSET_ID")||"",days:localStorage.getItem("ICS_SYNC_DAYS")||"50"},a=document.createElement("dialog");a.className="backdrop:bg-black/50 bg-white rounded-xl p-6 max-w-lg w-[90%] shadow-2xl";const f=Object.assign(document.createElement("h2"),{textContent:"ICS → Lunch Money Sync",className:"mb-5 text-xl font-semibold text-gray-900"}),u=Object.assign(document.createElement("label"),{textContent:"Lunch Money API Token",className:"block text-xs font-medium text-gray-500 mb-1"}),p=Object.assign(document.createElement("a"),{href:"https://my.lunchmoney.app/developers",target:"_blank",textContent:"Get token →",className:"text-xs text-green-600 hover:underline ml-2"});u.append(p);const l=Object.assign(document.createElement("input"),{type:"password",value:s.token,placeholder:"Paste your API token",className:"w-full px-3 py-2.5 border-2 border-gray-200 rounded-lg text-sm font-mono mb-1 focus:outline-none focus:border-green-500"}),t=Object.assign(document.createElement("div"),{className:"text-xs mb-4 h-5"}),h=Object.assign(document.createElement("label"),{textContent:"Lunch Money Account",className:"block text-xs font-medium text-gray-500 mb-1"}),n=Object.assign(document.createElement("select"),{className:"w-full px-3 py-2.5 border-2 border-gray-200 rounded-lg text-sm mb-4 focus:outline-none focus:border-green-500 bg-white",disabled:!0});n.innerHTML='<option value="">Enter token first...</option>';const S=Object.assign(document.createElement("label"),{textContent:"ICS Bank Account",className:"block text-xs font-medium text-gray-500 mb-1"}),c=Object.assign(document.createElement("select"),{className:"w-full px-3 py-2.5 border-2 border-gray-200 rounded-lg text-sm mb-4 focus:outline-none focus:border-green-500 bg-white",disabled:!0});c.innerHTML='<option value="">Loading ICS accounts...</option>';const $=Object.assign(document.createElement("label"),{textContent:"Days to sync",className:"block text-xs font-medium text-gray-500 mb-1"}),g=Object.assign(document.createElement("input"),{type:"number",value:s.days,min:"1",className:"w-full px-3 py-2.5 border-2 border-gray-200 rounded-lg text-sm mb-5 focus:outline-none focus:border-green-500"}),x=Object.assign(document.createElement("button"),{textContent:"Sync",disabled:!0,className:"w-full bg-green-500 hover:bg-green-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-white px-5 py-3 rounded-lg text-sm font-medium transition"});a.addEventListener("cancel",o=>o.preventDefault()),a.append(f,u,l,t,h,n,S,c,$,g,x),document.body.append(a),a.showModal(),queueMicrotask(()=>s.token?g.focus():l.focus());let w=[],k=[],T=!1,B=!1;const N=()=>{x.disabled=!(T&&B&&n.value&&c.value&&parseInt(g.value,10)>0)};n.addEventListener("change",N),c.addEventListener("change",N),g.addEventListener("input",N);const P=decodeURIComponent(document.cookie.match(/XSRF-TOKEN=([^;]+)/)?.[1]??"");(async()=>{try{const o=await fetch("/api/nl/sec/frontendservices/allaccountsv2",{headers:{"X-XSRF-TOKEN":P,Accept:"application/json"}});if(!o.ok){if(o.status===403){c.innerHTML='<option value="">Not logged in – log into ICS first</option>';return}throw new Error(`${o.status}`)}const i=await o.json();if(k=Array.isArray(i)?i:[i],k.length===0){c.innerHTML='<option value="">No accounts found</option>';return}c.disabled=!1,c.innerHTML=(k.length>1?'<option value="">Select account...</option>':"")+k.map(v=>`<option value="${v.accountNumber}">${v.accountNumber}${v.productDescription?" – "+v.productDescription:""}</option>`).join(""),B=!0,N()}catch(o){c.innerHTML=`<option value="">Error: ${o.message}</option>`}})();let F;const R=async o=>{if(!o||o.length<10){n.disabled=!0,n.innerHTML='<option value="">Enter token first...</option>',T=!1,t.textContent="",N();return}t.textContent="Loading accounts...",t.className="text-xs mb-4 h-5 text-gray-500",n.disabled=!0,n.innerHTML='<option value="">Loading...</option>',T=!1,N();try{const i=await fetch("https://dev.lunchmoney.app/v1/assets",{headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"}});if(!i.ok){t.textContent=i.status===401?"Invalid token":`Error: ${i.status}`,t.className="text-xs mb-4 h-5 text-red-500",n.innerHTML='<option value="">Fix token above</option>';return}if(w=(await i.json()).assets||[],w.length===0){t.textContent="No manual accounts found",t.className="text-xs mb-4 h-5 text-orange-500",n.innerHTML='<option value="">No accounts</option>';return}t.innerHTML=`✓ ${w.length} account${w.length>1?"s":""} loaded`,t.className="text-xs mb-4 h-5 text-green-600",n.disabled=!1;const O=y=>{try{return new Intl.NumberFormat(void 0,{style:"currency",currency:y.currency}).format(parseFloat(y.balance))}catch{return`${y.balance} ${y.currency}`}};n.innerHTML=(w.length>1?'<option value="">Select account...</option>':"")+w.map(y=>`<option value="${y.id}" ${String(y.id)===s.assetId?"selected":""}>${y.name} (${O(y)})</option>`).join(""),T=!0,localStorage.setItem("LUNCHMONEY_TOKEN",o),N()}catch{t.textContent="Network error",t.className="text-xs mb-4 h-5 text-red-500",n.innerHTML='<option value="">Error loading accounts</option>'}};l.addEventListener("input",()=>{clearTimeout(F),F=setTimeout(()=>R(l.value.trim()),500)}),s.token&&R(s.token),x.onclick=()=>{const o=l.value.trim(),i=n.value,v=c.value,O=parseInt(g.value,10);!o||!i||!v||O<1||(localStorage.setItem("LUNCHMONEY_TOKEN",o),localStorage.setItem("LUNCHMONEY_ASSET_ID",i),localStorage.setItem("ICS_SYNC_DAYS",String(O)),a.close(),a.remove(),e({token:o,assetId:i,icsAccount:v,days:O,xsrfToken:P}))},g.addEventListener("keypress",o=>{o.key==="Enter"&&!x.disabled&&x.click()})}),{token:M,assetId:z,icsAccount:A,days:X,xsrfToken:J}=await K(),C=new Date,b=new Date(C);b.setDate(b.getDate()-X);const r=(()=>{const e=document.createElement("dialog");e.className="backdrop:bg-black/80 bg-white rounded-xl p-8 max-w-lg w-[90%] shadow-2xl";const s=Object.assign(document.createElement("h2"),{textContent:"Syncing Transactions",className:"mb-4 text-2xl font-semibold text-gray-900"}),a=Object.assign(document.createElement("div"),{textContent:"Initializing...",className:"mb-4 text-sm text-gray-600"}),f=Object.assign(document.createElement("div"),{className:"w-full bg-gray-200 rounded-full h-2 mb-4"}),u=Object.assign(document.createElement("div"),{className:"bg-green-500 h-2 rounded-full transition-all duration-300",style:"width: 0%"});f.append(u);const p=Object.assign(document.createElement("div"),{className:"text-sm text-gray-500 space-y-1 mb-2"}),l=Object.assign(document.createElement("div"),{className:"text-xs text-gray-400 italic"});return e.append(s,a,f,p,l),document.body.append(e),e.showModal(),{dialog:e,updateStatus:t=>a.textContent=t,updateProgress:t=>u.style.width=`${t}%`,updateStats:(t,h)=>{p.innerHTML=`
          <div>Fetched from ICS: <strong>${t}</strong></div>
          <div>Sent to Lunch Money: <strong>${h}</strong></div>
        `},updateBatch:(t,h,n)=>{l.textContent=`Batch ${t}/${h} • ${n}`},close:()=>{e.close(),e.remove()}}})();r.updateStatus(`Fetching from account ${A}...`);let d=new Date(C),L=0,D=0;const q=Math.ceil((C-b)/(1e3*60*60*24));let H=0,I=0;const _=[];let E=new Date(C);for(;E>b;){const e=new Date(E);e.setDate(e.getDate()-30),e<b&&e.setTime(b.getTime()),_.push({from:new Date(e),until:new Date(E)}),E=new Date(e),E.setDate(E.getDate()-1)}const j=_.length;try{for(;d>b;){I++;const e=new Date(d);e.setDate(e.getDate()-30),e<b&&e.setTime(b.getTime());const s=Math.ceil((d-e)/(1e3*60*60*24));H+=s;const a=Math.min(H/q*100,95);r.updateProgress(a),r.updateStatus(`Fetching ${m(e)} to ${m(d)}...`),r.updateBatch(I,j,`${m(e)} → ${m(d)}`);const f=new URLSearchParams({accountNumber:A,debitCredit:"DEBIT_AND_CREDIT",fromDate:m(e),untilDate:m(d)}),u=await fetch(`/api/nl/sec/frontendservices/transactionsv3/search?${f}`,{headers:{"X-XSRF-TOKEN":J,Accept:"application/json"}});if(!u.ok)throw new Error(`ICS API error: ${u.status}`);const p=await u.json();if(!Array.isArray(p))break;L+=p.length,r.updateStats(L,D);const l=`importedAt:${new Date().toISOString()}`;let t;try{t=(await(await fetch("https://api.lunchmoney.dev/v2/tags",{method:"POST",headers:{Authorization:`Bearer ${M}`,"Content-Type":"application/json"},body:JSON.stringify({name:l})})).json()).id}catch{}const h=p.map(({transactionDate:n,description:S="",billingAmount:c,billingCurrency:$,sourceAmount:g,sourceCurrency:x,processingTime:w,batchNr:k,batchSequenceNr:T})=>({date:n,payee:S,amount:Number(c),manual_account_id:Number(z),tag_ids:t?[t]:[],notes:x&&x!==$?`Original: ${g} ${x}`:"",external_id:`${n}-${w||"000000"}-${k}-${T}-${c}`,status:"unreviewed"}));if(h.length>0){r.updateStatus(`Sending ${h.length} transactions to Lunch Money...`),r.updateBatch(I,j,`Sending batch ${I}/${j}...`);const n=await fetch("https://api.lunchmoney.dev/v2/transactions",{method:"POST",headers:{Authorization:`Bearer ${M}`,"Content-Type":"application/json"},body:JSON.stringify({transactions:h,apply_rules:!0,skip_duplicates:!0})});if(!n.ok&&n.status!==201){const g=await n.text();throw new Error(`Lunch Money API error: ${n.status} – ${g.substring(0,200)}`)}const S=await n.json(),c=S.transactions?.length||0,$=S.skipped_duplicates?.length||0;D+=c,r.updateStats(L,D),r.updateBatch(I,j,`${c} new, ${$} skipped • ${m(e)} → ${m(d)}`),console.log(`${m(e)} – ${m(d)}: ${c} inserted, ${$} skipped`)}d=new Date(e),d.setDate(d.getDate()-1)}r.updateProgress(100),r.updateStatus("Sync complete!"),r.updateStats(L,D),setTimeout(()=>{r.close(),U(`Sync done: ${L} fetched, ${D} sent to Lunch Money.`)},1500)}catch(e){console.error("Sync error:",e),r?.close(),Y("Sync Failed",`${e.message}<br><br>Check the browser console for details.`)}})();})();
