javascript: (()=>{(async()=>{const w=new Date,u=new Date(w);u.setDate(u.getDate()-50),document.getElementById("tw-cdn")||await new Promise(e=>{const n=Object.assign(document.createElement("script"),{id:"tw-cdn",src:"https://cdn.tailwindcss.com",onload:e});document.head.append(n)});const I=(e,n,a,m=!1)=>new Promise(d=>{const t=document.createElement("dialog");t.className="backdrop:bg-black/50 bg-white rounded-xl p-6 max-w-md w-[90%] shadow-2xl";const c=Object.assign(document.createElement("h2"),{textContent:e,className:"mb-4 text-xl font-semibold text-gray-900"}),g=Object.assign(document.createElement("div"),{innerHTML:n,className:"mb-5 text-sm leading-relaxed text-gray-600"}),o=Object.assign(document.createElement("input"),{type:m?"password":"text",placeholder:a,className:"w-full px-3 py-3 border-2 border-gray-200 rounded-lg text-sm mb-4 font-mono focus:outline-none focus:border-green-500"}),r=Object.assign(document.createElement("button"),{textContent:"Save",className:"bg-green-500 hover:bg-green-600 text-white px-5 py-2.5 rounded-lg text-sm font-medium transition",onclick:()=>{const h=o.value.trim();h&&(t.close(),t.remove(),d(h))}});o.addEventListener("keypress",h=>h.key==="Enter"&&r.click()),t.addEventListener("cancel",h=>{h.preventDefault()});const p=Object.assign(document.createElement("div"),{className:"flex gap-3 justify-end"});p.append(r),t.append(c,g,o,p),document.body.append(t),t.showModal(),queueMicrotask(()=>o.focus())}),f=(e,n)=>{const a=document.createElement("dialog");a.className="backdrop:bg-black/50 bg-white rounded-xl p-6 max-w-md w-[90%] shadow-2xl";const m=Object.assign(document.createElement("h2"),{textContent:e,className:"mb-4 text-xl font-semibold text-red-600"}),d=Object.assign(document.createElement("div"),{innerHTML:n,className:"mb-5 text-sm leading-relaxed text-gray-600"}),t=Object.assign(document.createElement("button"),{textContent:"Close",className:"bg-gray-500 hover:bg-gray-600 text-white px-5 py-2.5 rounded-lg text-sm font-medium transition",onclick:()=>{a.close(),a.remove()}}),c=Object.assign(document.createElement("div"),{className:"flex gap-3 justify-end"});c.append(t),a.append(m,d,c),document.body.append(a),a.showModal(),a.addEventListener("cancel",g=>{g.preventDefault(),a.close(),a.remove()})},$=async(e,n,a,m,d=!1)=>{const t=localStorage.getItem(e);if(t)return t;const c=await I(n,a,m,d);return localStorage.setItem(e,c),c},j=await $("LUNCHMONEY_ASSET_ID","üè¶ Lunch Money Asset ID",'Where to find your Asset ID:<br><br>1. Open <a href="https://my.lunchmoney.app/" target="_blank" class="text-green-600 hover:underline">Lunch Money</a><br>2. Click on your ICS/ABN AMRO account<br>3. The Asset ID is in the URL:<br><code class="bg-gray-100 px-2 py-1 rounded block mt-2">https://my.lunchmoney.app/transactions/...?<strong>asset=12345</strong></code><br>Use the number after <code class="bg-gray-100 px-1">asset=</code>',"Example: 12345"),A=await $("LUNCHMONEY_TOKEN","üîë Lunch Money API Token",'Where to get your token:<br><br>1. Open <a href="https://my.lunchmoney.app/developers" target="_blank" class="text-green-600 hover:underline">https://my.lunchmoney.app/developers</a><br>2. Click the <strong>"Request new access token"</strong> button<br>3. Copy the generated token',"Paste your API token",!0),l=e=>new Intl.DateTimeFormat("sv-SE").format(e),M=()=>{const e=document.createElement("dialog");e.className="backdrop:bg-black/80 bg-white rounded-xl p-8 max-w-lg w-[90%] shadow-2xl";const n=Object.assign(document.createElement("h2"),{textContent:"üîÑ Syncing Transactions",className:"mb-4 text-2xl font-semibold text-gray-900"}),a=Object.assign(document.createElement("div"),{textContent:"Initializing...",className:"mb-4 text-sm text-gray-600"}),m=Object.assign(document.createElement("div"),{className:"mb-4"}),d=Object.assign(document.createElement("div"),{className:"w-full bg-gray-200 rounded-full h-2"}),t=Object.assign(document.createElement("div"),{className:"bg-green-500 h-2 rounded-full transition-all duration-300",style:"width: 0%"});d.append(t),m.append(d);const c=Object.assign(document.createElement("div"),{className:"text-sm text-gray-500 space-y-1 mb-2"}),g=Object.assign(document.createElement("div"),{className:"text-xs text-gray-400 italic"});return e.append(n,a,m,c,g),document.body.append(e),e.showModal(),{dialog:e,updateStatus:o=>{a.textContent=o},updateProgress:o=>{t.style.width=`${o}%`},updateStats:(o,r)=>{c.innerHTML=`
          <div>üì• Fetched FROM ICS: <strong>${o}</strong> transactions</div>
          <div>üì§ Sent TO Lunch Money: <strong>${r}</strong> transactions</div>
        `},updateBatch:(o,r,p)=>{g.textContent=`Batch ${o} of ${r} ‚Ä¢ ${p}`},close:()=>{e.close(),e.remove()}}},P=e=>{const n=Object.assign(document.createElement("div"),{textContent:e,className:"fixed bottom-5 right-5 px-5 py-3 bg-gray-800 text-white rounded-lg z-[9999]"});document.body.append(n),setTimeout(()=>n.remove(),1e4)},S=decodeURIComponent(document.cookie.match(/XSRF-TOKEN=([^;]+)/)?.[1]??"");let N;try{const e=await fetch("/api/nl/sec/frontendservices/allaccountsv2",{headers:{"X-XSRF-TOKEN":S,Accept:"application/json"}});if(!e.ok){if(e.status===403){f("‚ùå Authentication Failed","Please make sure you're logged into ICS Cards and viewing your account page, then try again.<br><br>If you're not logged in, please log in first and navigate to your transactions page.");return}throw new Error(`Failed to fetch accounts: ${e.status}`)}const n=await e.json();if(N=Array.isArray(n)?n:[n],N.length===0){f("‚ùå No Accounts Found","No accounts were found. Please make sure you're logged in and have access to at least one account.");return}}catch(e){e.name==="TypeError"&&e.message.includes("fetch")?f("‚ùå Network Error","Failed to connect to ICS Cards. Please check your internet connection and try again."):f("‚ùå Error",`An error occurred: ${e.message}<br><br>Please make sure you're logged into ICS Cards and try again.`);return}const k=N[0].accountNumber;console.log(`Using account: ${k}`);const s=M();s.updateStatus(`Using account: ${k}`),s.updateProgress(0);let i=new Date(w),x=0,E=0;const B=Math.ceil((w-u)/(1e3*60*60*24));let O=0,b=0;const T=[];let y=new Date(w);for(;y>u;){const e=new Date(y);e.setDate(e.getDate()-30),e<u&&e.setTime(u.getTime()),T.push({from:new Date(e),until:new Date(y)}),y=new Date(e),y.setDate(y.getDate()-1)}const v=T.length;try{for(;i>u;){b++;const e=new Date(i);e.setDate(e.getDate()-30),e<u&&e.setTime(u.getTime());const n=Math.ceil((i-e)/(1e3*60*60*24));O+=n;const a=Math.min(O/B*100,95);s.updateProgress(a),s.updateStatus(`Fetching transactions from ${l(e)} to ${l(i)}...`),s.updateBatch(b,v,`${l(e)} ‚Üí ${l(i)}`);const d=`/api/nl/sec/frontendservices/transactionsv3/search?${new URLSearchParams({accountNumber:k,debitCredit:"DEBIT_AND_CREDIT",fromDate:l(e),untilDate:l(i)})}`,t=await fetch(d,{headers:{"X-XSRF-TOKEN":S,Accept:"application/json"}});if(!t.ok)throw new Error(`Bank API error: ${t.status} ${t.statusText}`);const c=await t.json();if(!Array.isArray(c)){console.error("Bank API error:",c);break}x+=c.length,s.updateStats(x,E);const g=`importedAt:${l(w)}`,o=c.map(({transactionDate:r,description:p="",billingAmount:h,merchantCategoryCodeDescription:D,typeOfPurchase:C,batchNr:_,batchSequenceNr:L})=>({date:r,payee:p,amount:-Number(h),asset_id:j,category_name:D,tags:[D&&`ics:merchantCategoryCodeDescription:${D}`,C&&`ics:typeOfPurchase:${C}`,g].filter(Boolean),notes:"",external_id:`${_}-${L}`}));if(o.length>0){s.updateStatus(`Sending ${o.length} transactions to Lunch Money...`),s.updateBatch(b,v,`Sending batch ${b}/${v}...`);const r=await fetch("https://dev.lunchmoney.app/v1/transactions",{method:"POST",headers:{Authorization:`Bearer ${A}`,"Content-Type":"application/json"},body:JSON.stringify({transactions:o,apply_rules:!0,check_for_recurring:!0,skip_duplicates:!0})});if(!r.ok)throw new Error(`Lunch Money API error: ${r.status} ${r.statusText}`);const p=await r.json();E+=o.length,s.updateStats(x,E),s.updateBatch(b,v,`Batch ${b}/${v} complete ‚Ä¢ ${l(e)} ‚Üí ${l(i)}`),console.log(`Interval ${l(e)} ‚Äì ${l(i)}:`,p)}i=new Date(e),i.setDate(i.getDate()-1)}s.updateProgress(100),s.updateStatus("‚úÖ Sync complete!"),s.updateStats(x,E),setTimeout(()=>{s.close(),P(`Sync complete. Fetched ${x} transactions, sent ${E}.`)},1500)}catch(e){console.error("Error syncing historical data:",e),typeof s<"u"&&s&&s.close(),f("‚ùå Sync Failed",`An error occurred while syncing transactions: ${e.message}<br><br>Please try again or check the browser console for more details.`)}})();})();
