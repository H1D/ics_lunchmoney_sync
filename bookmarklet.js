javascript: (()=>{(async()=>{const v=new Date,m=new Date(v);m.setDate(m.getDate()-50),document.getElementById("tw-cdn")||await new Promise(e=>{const n=Object.assign(document.createElement("script"),{id:"tw-cdn",src:"https://cdn.tailwindcss.com",onload:e});document.head.append(n)});const A=(e,n,a,g=!1)=>new Promise(u=>{const t=document.createElement("dialog");t.className="backdrop:bg-black/50 bg-white rounded-xl p-6 max-w-md w-[90%] shadow-2xl";const c=Object.assign(document.createElement("h2"),{textContent:e,className:"mb-4 text-xl font-semibold text-gray-900"}),h=Object.assign(document.createElement("div"),{innerHTML:n,className:"mb-5 text-sm leading-relaxed text-gray-600"}),o=Object.assign(document.createElement("input"),{type:g?"password":"text",placeholder:a,className:"w-full px-3 py-3 border-2 border-gray-200 rounded-lg text-sm mb-4 font-mono focus:outline-none focus:border-green-500"}),r=Object.assign(document.createElement("button"),{textContent:"Save",className:"bg-green-500 hover:bg-green-600 text-white px-5 py-2.5 rounded-lg text-sm font-medium transition",onclick:()=>{const i=o.value.trim();i&&(t.close(),t.remove(),u(i))}});o.addEventListener("keypress",i=>i.key==="Enter"&&r.click()),t.addEventListener("cancel",i=>{i.preventDefault()});const p=Object.assign(document.createElement("div"),{className:"flex gap-3 justify-end"});p.append(r),t.append(c,h,o,p),document.body.append(t),t.showModal(),queueMicrotask(()=>o.focus())}),w=(e,n)=>{const a=document.createElement("dialog");a.className="backdrop:bg-black/50 bg-white rounded-xl p-6 max-w-md w-[90%] shadow-2xl";const g=Object.assign(document.createElement("h2"),{textContent:e,className:"mb-4 text-xl font-semibold text-red-600"}),u=Object.assign(document.createElement("div"),{innerHTML:n,className:"mb-5 text-sm leading-relaxed text-gray-600"}),t=Object.assign(document.createElement("button"),{textContent:"Close",className:"bg-gray-500 hover:bg-gray-600 text-white px-5 py-2.5 rounded-lg text-sm font-medium transition",onclick:()=>{a.close(),a.remove()}}),c=Object.assign(document.createElement("div"),{className:"flex gap-3 justify-end"});c.append(t),a.append(g,u,c),document.body.append(a),a.showModal(),a.addEventListener("cancel",h=>{h.preventDefault(),a.close(),a.remove()})},T=async(e,n,a,g,u=!1)=>{const t=localStorage.getItem(e);if(t)return t;const c=await A(n,a,g,u);return localStorage.setItem(e,c),c},M=await T("LUNCHMONEY_ASSET_ID","üè¶ Lunch Money Asset ID",'Where to find your Asset ID:<br><br>1. Open <a href="https://my.lunchmoney.app/" target="_blank" class="text-green-600 hover:underline">Lunch Money</a><br>2. Click on your ICS/ABN AMRO account<br>3. The Asset ID is in the URL:<br><code class="bg-gray-100 px-2 py-1 rounded block mt-2">https://my.lunchmoney.app/transactions/...?<strong>asset=12345</strong></code><br>Use the number after <code class="bg-gray-100 px-1">asset=</code>',"Example: 12345"),P=await T("LUNCHMONEY_TOKEN","üîë Lunch Money API Token",'Where to get your token:<br><br>1. Open <a href="https://my.lunchmoney.app/developers" target="_blank" class="text-green-600 hover:underline">https://my.lunchmoney.app/developers</a><br>2. Click the <strong>"Request new access token"</strong> button<br>3. Copy the generated token',"Paste your API token",!0),d=e=>new Intl.DateTimeFormat("sv-SE").format(e),B=()=>{const e=document.createElement("dialog");e.className="backdrop:bg-black/80 bg-white rounded-xl p-8 max-w-lg w-[90%] shadow-2xl";const n=Object.assign(document.createElement("h2"),{textContent:"üîÑ Syncing Transactions",className:"mb-4 text-2xl font-semibold text-gray-900"}),a=Object.assign(document.createElement("div"),{textContent:"Initializing...",className:"mb-4 text-sm text-gray-600"}),g=Object.assign(document.createElement("div"),{className:"mb-4"}),u=Object.assign(document.createElement("div"),{className:"w-full bg-gray-200 rounded-full h-2"}),t=Object.assign(document.createElement("div"),{className:"bg-green-500 h-2 rounded-full transition-all duration-300",style:"width: 0%"});u.append(t),g.append(u);const c=Object.assign(document.createElement("div"),{className:"text-sm text-gray-500 space-y-1 mb-2"}),h=Object.assign(document.createElement("div"),{className:"text-xs text-gray-400 italic"});return e.append(n,a,g,c,h),document.body.append(e),e.showModal(),{dialog:e,updateStatus:o=>{a.textContent=o},updateProgress:o=>{t.style.width=`${o}%`},updateStats:(o,r)=>{c.innerHTML=`
          <div>üì• Fetched FROM ICS: <strong>${o}</strong> transactions</div>
          <div>üì§ Sent TO Lunch Money: <strong>${r}</strong> transactions</div>
        `},updateBatch:(o,r,p)=>{h.textContent=`Batch ${o} of ${r} ‚Ä¢ ${p}`},close:()=>{e.close(),e.remove()}}},L=e=>{const n=Object.assign(document.createElement("div"),{textContent:e,className:"fixed bottom-5 right-5 px-5 py-3 bg-gray-800 text-white rounded-lg z-[9999]"});document.body.append(n),setTimeout(()=>n.remove(),1e4)},C=decodeURIComponent(document.cookie.match(/XSRF-TOKEN=([^;]+)/)?.[1]??"");let N;try{const e=await fetch("/api/nl/sec/frontendservices/allaccountsv2",{headers:{"X-XSRF-TOKEN":C,Accept:"application/json"}});if(!e.ok){if(e.status===403){w("‚ùå Authentication Failed","Please make sure you're logged into ICS Cards and viewing your account page, then try again.<br><br>If you're not logged in, please log in first and navigate to your transactions page.");return}throw new Error(`Failed to fetch accounts: ${e.status}`)}const n=await e.json();if(N=Array.isArray(n)?n:[n],N.length===0){w("‚ùå No Accounts Found","No accounts were found. Please make sure you're logged in and have access to at least one account.");return}}catch(e){e.name==="TypeError"&&e.message.includes("fetch")?w("‚ùå Network Error","Failed to connect to ICS Cards. Please check your internet connection and try again."):w("‚ùå Error",`An error occurred: ${e.message}<br><br>Please make sure you're logged into ICS Cards and try again.`);return}const k=N[0].accountNumber;console.log(`Using account: ${k}`);const s=B();s.updateStatus(`Using account: ${k}`),s.updateProgress(0);let l=new Date(v),f=0,x=0;const _=Math.ceil((v-m)/(1e3*60*60*24));let I=0,b=0;const j=[];let y=new Date(v);for(;y>m;){const e=new Date(y);e.setDate(e.getDate()-30),e<m&&e.setTime(m.getTime()),j.push({from:new Date(e),until:new Date(y)}),y=new Date(e),y.setDate(y.getDate()-1)}const E=j.length;try{for(;l>m;){b++;const e=new Date(l);e.setDate(e.getDate()-30),e<m&&e.setTime(m.getTime());const n=Math.ceil((l-e)/(1e3*60*60*24));I+=n;const a=Math.min(I/_*100,95);s.updateProgress(a),s.updateStatus(`Fetching transactions from ${d(e)} to ${d(l)}...`),s.updateBatch(b,E,`${d(e)} ‚Üí ${d(l)}`);const u=`/api/nl/sec/frontendservices/transactionsv3/search?${new URLSearchParams({accountNumber:k,debitCredit:"DEBIT_AND_CREDIT",fromDate:d(e),untilDate:d(l)})}`,t=await fetch(u,{headers:{"X-XSRF-TOKEN":C,Accept:"application/json"}});if(!t.ok)throw new Error(`Bank API error: ${t.status} ${t.statusText}`);const c=await t.json();if(!Array.isArray(c)){console.error("Bank API error:",c);break}f+=c.length,s.updateStats(f,x);const h=new Date().toISOString(),o=c.map(({transactionDate:r,description:p="",billingAmount:i,billingCurrency:$,sourceAmount:D,sourceCurrency:S,processingTime:F,batchNr:R,batchSequenceNr:U})=>{const H=Number(i);let O=`Imported: ${h}`;return S&&S!==$&&(O=`Original: ${D} ${S} | ${O}`),{date:r,payee:p,amount:H,manual_account_id:Number(M),notes:O,external_id:`${r}-${F||"000000"}-${R}-${U}-${i}`,status:"unreviewed"}});if(o.length>0){s.updateStatus(`Sending ${o.length} transactions to Lunch Money...`),s.updateBatch(b,E,`Sending batch ${b}/${E}...`);const r=await fetch("https://api.lunchmoney.dev/v2/transactions",{method:"POST",headers:{Authorization:`Bearer ${P}`,"Content-Type":"application/json"},body:JSON.stringify({transactions:o,apply_rules:!0,skip_duplicates:!0})});if(!r.ok&&r.status!==201){const D=await r.text();throw new Error(`Lunch Money API error: ${r.status} ${r.statusText} - ${D.substring(0,200)}`)}const p=await r.json(),i=p.transactions?.length||0,$=p.skipped_duplicates?.length||0;x+=i,s.updateStats(f,x),s.updateBatch(b,E,`Batch ${b}/${E} complete (${i} new, ${$} skipped) ‚Ä¢ ${d(e)} ‚Üí ${d(l)}`),console.log(`Interval ${d(e)} ‚Äì ${d(l)}: ${i} inserted, ${$} skipped`)}l=new Date(e),l.setDate(l.getDate()-1)}s.updateProgress(100),s.updateStatus("‚úÖ Sync complete!"),s.updateStats(f,x),setTimeout(()=>{s.close(),L(`Sync complete. Fetched ${f} transactions, sent ${x}.`)},1500)}catch(e){console.error("Error syncing historical data:",e),typeof s<"u"&&s&&s.close(),w("‚ùå Sync Failed",`An error occurred while syncing transactions: ${e.message}<br><br>Please try again or check the browser console for more details.`)}})();})();
