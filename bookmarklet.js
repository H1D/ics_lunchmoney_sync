javascript: (()=>{(async()=>{const w=new Date,m=new Date(w);m.setDate(m.getDate()-50),document.getElementById("tw-cdn")||await new Promise(e=>{const n=Object.assign(document.createElement("script"),{id:"tw-cdn",src:"https://cdn.tailwindcss.com",onload:e});document.head.append(n)});const M=(e,n,a,u=!1)=>new Promise(d=>{const t=document.createElement("dialog");t.className="backdrop:bg-black/50 bg-white rounded-xl p-6 max-w-md w-[90%] shadow-2xl";const c=Object.assign(document.createElement("h2"),{textContent:e,className:"mb-4 text-xl font-semibold text-gray-900"}),p=Object.assign(document.createElement("div"),{innerHTML:n,className:"mb-5 text-sm leading-relaxed text-gray-600"}),o=Object.assign(document.createElement("input"),{type:u?"password":"text",placeholder:a,className:"w-full px-3 py-3 border-2 border-gray-200 rounded-lg text-sm mb-4 font-mono focus:outline-none focus:border-green-500"}),r=Object.assign(document.createElement("button"),{textContent:"Save",className:"bg-green-500 hover:bg-green-600 text-white px-5 py-2.5 rounded-lg text-sm font-medium transition",onclick:()=>{const g=o.value.trim();g&&(t.close(),t.remove(),d(g))}});o.addEventListener("keypress",g=>g.key==="Enter"&&r.click()),t.addEventListener("cancel",g=>{g.preventDefault()});const h=Object.assign(document.createElement("div"),{className:"flex gap-3 justify-end"});h.append(r),t.append(c,p,o,h),document.body.append(t),t.showModal(),queueMicrotask(()=>o.focus())}),f=(e,n)=>{const a=document.createElement("dialog");a.className="backdrop:bg-black/50 bg-white rounded-xl p-6 max-w-md w-[90%] shadow-2xl";const u=Object.assign(document.createElement("h2"),{textContent:e,className:"mb-4 text-xl font-semibold text-red-600"}),d=Object.assign(document.createElement("div"),{innerHTML:n,className:"mb-5 text-sm leading-relaxed text-gray-600"}),t=Object.assign(document.createElement("button"),{textContent:"Close",className:"bg-gray-500 hover:bg-gray-600 text-white px-5 py-2.5 rounded-lg text-sm font-medium transition",onclick:()=>{a.close(),a.remove()}}),c=Object.assign(document.createElement("div"),{className:"flex gap-3 justify-end"});c.append(t),a.append(u,d,c),document.body.append(a),a.showModal(),a.addEventListener("cancel",p=>{p.preventDefault(),a.close(),a.remove()})},S=async(e,n,a,u,d=!1)=>{const t=localStorage.getItem(e);if(t)return t;const c=await M(n,a,u,d);return localStorage.setItem(e,c),c},P=await S("LUNCHMONEY_ASSET_ID","üè¶ Lunch Money Asset ID",'Where to find your Asset ID:<br><br>1. Open <a href="https://my.lunchmoney.app/" target="_blank" class="text-green-600 hover:underline">Lunch Money</a><br>2. Click on your ICS/ABN AMRO account<br>3. The Asset ID is in the URL:<br><code class="bg-gray-100 px-2 py-1 rounded block mt-2">https://my.lunchmoney.app/transactions/...?<strong>asset=12345</strong></code><br>Use the number after <code class="bg-gray-100 px-1">asset=</code>',"Example: 12345"),B=await S("LUNCHMONEY_TOKEN","üîë Lunch Money API Token",'Where to get your token:<br><br>1. Open <a href="https://my.lunchmoney.app/developers" target="_blank" class="text-green-600 hover:underline">https://my.lunchmoney.app/developers</a><br>2. Click the <strong>"Request new access token"</strong> button<br>3. Copy the generated token',"Paste your API token",!0),l=e=>new Intl.DateTimeFormat("sv-SE").format(e),_=()=>{const e=document.createElement("dialog");e.className="backdrop:bg-black/80 bg-white rounded-xl p-8 max-w-lg w-[90%] shadow-2xl";const n=Object.assign(document.createElement("h2"),{textContent:"üîÑ Syncing Transactions",className:"mb-4 text-2xl font-semibold text-gray-900"}),a=Object.assign(document.createElement("div"),{textContent:"Initializing...",className:"mb-4 text-sm text-gray-600"}),u=Object.assign(document.createElement("div"),{className:"mb-4"}),d=Object.assign(document.createElement("div"),{className:"w-full bg-gray-200 rounded-full h-2"}),t=Object.assign(document.createElement("div"),{className:"bg-green-500 h-2 rounded-full transition-all duration-300",style:"width: 0%"});d.append(t),u.append(d);const c=Object.assign(document.createElement("div"),{className:"text-sm text-gray-500 space-y-1 mb-2"}),p=Object.assign(document.createElement("div"),{className:"text-xs text-gray-400 italic"});return e.append(n,a,u,c,p),document.body.append(e),e.showModal(),{dialog:e,updateStatus:o=>{a.textContent=o},updateProgress:o=>{t.style.width=`${o}%`},updateStats:(o,r)=>{c.innerHTML=`
          <div>üì• Fetched FROM ICS: <strong>${o}</strong> transactions</div>
          <div>üì§ Sent TO Lunch Money: <strong>${r}</strong> transactions</div>
        `},updateBatch:(o,r,h)=>{p.textContent=`Batch ${o} of ${r} ‚Ä¢ ${h}`},close:()=>{e.close(),e.remove()}}},L=e=>{const n=Object.assign(document.createElement("div"),{textContent:e,className:"fixed bottom-5 right-5 px-5 py-3 bg-gray-800 text-white rounded-lg z-[9999]"});document.body.append(n),setTimeout(()=>n.remove(),1e4)},O=decodeURIComponent(document.cookie.match(/XSRF-TOKEN=([^;]+)/)?.[1]??"");let $;try{const e=await fetch("/api/nl/sec/frontendservices/allaccountsv2",{headers:{"X-XSRF-TOKEN":O,Accept:"application/json"}});if(!e.ok){if(e.status===403){f("‚ùå Authentication Failed","Please make sure you're logged into ICS Cards and viewing your account page, then try again.<br><br>If you're not logged in, please log in first and navigate to your transactions page.");return}throw new Error(`Failed to fetch accounts: ${e.status}`)}const n=await e.json();if($=Array.isArray(n)?n:[n],$.length===0){f("‚ùå No Accounts Found","No accounts were found. Please make sure you're logged in and have access to at least one account.");return}}catch(e){e.name==="TypeError"&&e.message.includes("fetch")?f("‚ùå Network Error","Failed to connect to ICS Cards. Please check your internet connection and try again."):f("‚ùå Error",`An error occurred: ${e.message}<br><br>Please make sure you're logged into ICS Cards and try again.`);return}const N=$[0].accountNumber;console.log(`Using account: ${N}`);const s=_();s.updateStatus(`Using account: ${N}`),s.updateProgress(0);let i=new Date(w),x=0,E=0;const F=Math.ceil((w-m)/(1e3*60*60*24));let T=0,b=0;const I=[];let y=new Date(w);for(;y>m;){const e=new Date(y);e.setDate(e.getDate()-30),e<m&&e.setTime(m.getTime()),I.push({from:new Date(e),until:new Date(y)}),y=new Date(e),y.setDate(y.getDate()-1)}const v=I.length;try{for(;i>m;){b++;const e=new Date(i);e.setDate(e.getDate()-30),e<m&&e.setTime(m.getTime());const n=Math.ceil((i-e)/(1e3*60*60*24));T+=n;const a=Math.min(T/F*100,95);s.updateProgress(a),s.updateStatus(`Fetching transactions from ${l(e)} to ${l(i)}...`),s.updateBatch(b,v,`${l(e)} ‚Üí ${l(i)}`);const d=`/api/nl/sec/frontendservices/transactionsv3/search?${new URLSearchParams({accountNumber:N,debitCredit:"DEBIT_AND_CREDIT",fromDate:l(e),untilDate:l(i)})}`,t=await fetch(d,{headers:{"X-XSRF-TOKEN":O,Accept:"application/json"}});if(!t.ok)throw new Error(`Bank API error: ${t.status} ${t.statusText}`);const c=await t.json();if(!Array.isArray(c)){console.error("Bank API error:",c);break}x+=c.length,s.updateStats(x,E);const p=`importedAt:${l(w)}`,o=c.map(({transactionDate:r,description:h="",billingAmount:g,billingCurrency:R,sourceAmount:U,sourceCurrency:k,merchantCategoryCodeDescription:D,typeOfPurchase:j,countryCode:A,lastFourDigits:C,processingTime:H,batchNr:K,batchSequenceNr:X})=>({date:r,payee:h,amount:-Number(g),asset_id:P,category_name:D,tags:[D&&`ics:category:${D}`,j&&`ics:type:${j}`,A&&`ics:country:${A}`,C&&`ics:card:${C}`,p].filter(Boolean),notes:k&&k!==R?`Original: ${U} ${k}`:"",external_id:`${r}-${H||"000000"}-${K}-${X}-${g}`}));if(o.length>0){s.updateStatus(`Sending ${o.length} transactions to Lunch Money...`),s.updateBatch(b,v,`Sending batch ${b}/${v}...`);const r=await fetch("https://dev.lunchmoney.app/v1/transactions",{method:"POST",headers:{Authorization:`Bearer ${B}`,"Content-Type":"application/json"},body:JSON.stringify({transactions:o,apply_rules:!0,check_for_recurring:!0,skip_duplicates:!0})});if(!r.ok)throw new Error(`Lunch Money API error: ${r.status} ${r.statusText}`);const h=await r.json();E+=o.length,s.updateStats(x,E),s.updateBatch(b,v,`Batch ${b}/${v} complete ‚Ä¢ ${l(e)} ‚Üí ${l(i)}`),console.log(`Interval ${l(e)} ‚Äì ${l(i)}:`,h)}i=new Date(e),i.setDate(i.getDate()-1)}s.updateProgress(100),s.updateStatus("‚úÖ Sync complete!"),s.updateStats(x,E),setTimeout(()=>{s.close(),L(`Sync complete. Fetched ${x} transactions, sent ${E}.`)},1500)}catch(e){console.error("Error syncing historical data:",e),typeof s<"u"&&s&&s.close(),f("‚ùå Sync Failed",`An error occurred while syncing transactions: ${e.message}<br><br>Please try again or check the browser console for more details.`)}})();})();
