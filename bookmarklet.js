javascript: (()=>{(async()=>{const w=new Date,i=new Date(w);i.setDate(i.getDate()-50),document.getElementById("tw-cdn")||await new Promise(e=>{const o=Object.assign(document.createElement("script"),{id:"tw-cdn",src:"https://cdn.tailwindcss.com",onload:e});document.head.append(o)});const M=(e,o,d,g=!1)=>new Promise(m=>{const t=document.createElement("dialog");t.className="backdrop:bg-black/50 bg-white rounded-xl p-6 max-w-md w-[90%] shadow-2xl";const c=Object.assign(document.createElement("h2"),{textContent:e,className:"mb-4 text-xl font-semibold text-gray-900"}),y=Object.assign(document.createElement("div"),{innerHTML:o,className:"mb-5 text-sm leading-relaxed text-gray-600"}),n=Object.assign(document.createElement("input"),{type:g?"password":"text",placeholder:d,className:"w-full px-3 py-3 border-2 border-gray-200 rounded-lg text-sm mb-4 font-mono focus:outline-none focus:border-green-500"}),s=Object.assign(document.createElement("button"),{textContent:"Save",className:"bg-green-500 hover:bg-green-600 text-white px-5 py-2.5 rounded-lg text-sm font-medium transition",onclick:()=>{const p=n.value.trim();p&&(t.close(),t.remove(),m(p))}});n.addEventListener("keypress",p=>p.key==="Enter"&&s.click()),t.addEventListener("cancel",p=>{p.preventDefault()});const u=Object.assign(document.createElement("div"),{className:"flex gap-3 justify-end"});u.append(s),t.append(c,y,n,u),document.body.append(t),t.showModal(),queueMicrotask(()=>n.focus())}),S=async(e,o,d,g,m=!1)=>{const t=localStorage.getItem(e);if(t)return t;const c=await M(o,d,g,m);return localStorage.setItem(e,c),c},C=await S("LUNCHMONEY_ASSET_ID","ğŸ¦ Lunch Money Asset ID",'Where to find your Asset ID:<br><br>1. Open <a href="https://my.lunchmoney.app/" target="_blank" class="text-green-600 hover:underline">Lunch Money</a><br>2. Click on your ICS/ABN AMRO account<br>3. The Asset ID is in the URL:<br><code class="bg-gray-100 px-2 py-1 rounded block mt-2">https://my.lunchmoney.app/transactions/...?<strong>asset=12345</strong></code><br>Use the number after <code class="bg-gray-100 px-1">asset=</code>',"Example: 12345"),P=await S("LUNCHMONEY_TOKEN","ğŸ”‘ Lunch Money API Token",'Where to get your token:<br><br>1. Open <a href="https://my.lunchmoney.app/developers" target="_blank" class="text-green-600 hover:underline">https://my.lunchmoney.app/developers</a><br>2. Click the <strong>"Request new access token"</strong> button<br>3. Copy the generated token',"Paste your API token",!0),r=e=>new Intl.DateTimeFormat("sv-SE").format(e),B=()=>{const e=document.createElement("dialog");e.className="backdrop:bg-black/80 bg-white rounded-xl p-8 max-w-lg w-[90%] shadow-2xl";const o=Object.assign(document.createElement("h2"),{textContent:"ğŸ”„ Syncing Transactions",className:"mb-4 text-2xl font-semibold text-gray-900"}),d=Object.assign(document.createElement("div"),{textContent:"Initializing...",className:"mb-4 text-sm text-gray-600"}),g=Object.assign(document.createElement("div"),{className:"mb-4"}),m=Object.assign(document.createElement("div"),{className:"w-full bg-gray-200 rounded-full h-2"}),t=Object.assign(document.createElement("div"),{className:"bg-green-500 h-2 rounded-full transition-all duration-300",style:"width: 0%"});m.append(t),g.append(m);const c=Object.assign(document.createElement("div"),{className:"text-sm text-gray-500 space-y-1 mb-2"}),y=Object.assign(document.createElement("div"),{className:"text-xs text-gray-400 italic"});return e.append(o,d,g,c,y),document.body.append(e),e.showModal(),{dialog:e,updateStatus:n=>{d.textContent=n},updateProgress:n=>{t.style.width=`${n}%`},updateStats:(n,s)=>{c.innerHTML=`
          <div>ğŸ“¥ Fetched FROM ICS: <strong>${n}</strong> transactions</div>
          <div>ğŸ“¤ Sent TO Lunch Money: <strong>${s}</strong> transactions</div>
        `},updateBatch:(n,s,u)=>{y.textContent=`Batch ${n} of ${s} â€¢ ${u}`},close:()=>{e.close(),e.remove()}}},O=e=>{const o=Object.assign(document.createElement("div"),{textContent:e,className:"fixed bottom-5 right-5 px-5 py-3 bg-gray-800 text-white rounded-lg z-[9999]"});document.body.append(o),setTimeout(()=>o.remove(),1e4)},k=decodeURIComponent(document.cookie.match(/XSRF-TOKEN=([^;]+)/)?.[1]??""),v=await fetch("/api/nl/sec/frontendservices/allaccountsv2",{headers:{"X-XSRF-TOKEN":k,Accept:"application/json"}});if(!v.ok)throw new Error(`Failed to fetch accounts: ${v.status}`);const D=await v.json(),T=Array.isArray(D)?D:[D];if(T.length===0)throw new Error("No accounts found");const N=T[0].accountNumber;console.log(`Using account: ${N}`);const a=B();a.updateStatus(`Using account: ${N}`),a.updateProgress(0);let l=new Date(w),f=0,x=0;const _=Math.ceil((w-i)/(1e3*60*60*24));let I=0,h=0;const A=[];let b=new Date(w);for(;b>i;){const e=new Date(b);e.setDate(e.getDate()-30),e<i&&e.setTime(i.getTime()),A.push({from:new Date(e),until:new Date(b)}),b=new Date(e),b.setDate(b.getDate()-1)}const E=A.length;try{for(;l>i;){h++;const e=new Date(l);e.setDate(e.getDate()-30),e<i&&e.setTime(i.getTime());const o=Math.ceil((l-e)/(1e3*60*60*24));I+=o;const d=Math.min(I/_*100,95);a.updateProgress(d),a.updateStatus(`Fetching transactions from ${r(e)} to ${r(l)}...`),a.updateBatch(h,E,`${r(e)} â†’ ${r(l)}`);const m=`/api/nl/sec/frontendservices/transactionsv3/search?${new URLSearchParams({accountNumber:N,debitCredit:"DEBIT_AND_CREDIT",fromDate:r(e),untilDate:r(l)})}`,t=await fetch(m,{headers:{"X-XSRF-TOKEN":k,Accept:"application/json"}});if(!t.ok)throw new Error(`Bank API error: ${t.status} ${t.statusText}`);const c=await t.json();if(!Array.isArray(c)){console.error("Bank API error:",c);break}f+=c.length,a.updateStats(f,x);const y=`importedAt:${r(w)}`,n=c.map(({transactionDate:s,description:u="",billingAmount:p,merchantCategoryCodeDescription:$,typeOfPurchase:j,batchNr:L,batchSequenceNr:R})=>({date:s,payee:u,amount:-Number(p),asset_id:C,category_name:$,tags:[$&&`ics:merchantCategoryCodeDescription:${$}`,j&&`ics:typeOfPurchase:${j}`,y].filter(Boolean),notes:"",external_id:`${L}-${R}`}));if(n.length>0){a.updateStatus(`Sending ${n.length} transactions to Lunch Money...`),a.updateBatch(h,E,`Sending batch ${h}/${E}...`);const s=await fetch("https://dev.lunchmoney.app/v1/transactions",{method:"POST",headers:{Authorization:`Bearer ${P}`,"Content-Type":"application/json"},body:JSON.stringify({transactions:n,apply_rules:!0,check_for_recurring:!0})});if(!s.ok)throw new Error(`Lunch Money API error: ${s.status} ${s.statusText}`);const u=await s.json();x+=n.length,a.updateStats(f,x),a.updateBatch(h,E,`Batch ${h}/${E} complete â€¢ ${r(e)} â†’ ${r(l)}`),console.log(`Interval ${r(e)} â€“ ${r(l)}:`,u)}l=new Date(e),l.setDate(l.getDate()-1)}a.updateProgress(100),a.updateStatus("âœ… Sync complete!"),a.updateStats(f,x),setTimeout(()=>{a.close(),O(`Sync complete. Fetched ${f} transactions, sent ${x}.`)},1500)}catch(e){console.error("Error syncing historical data:",e),a.close(),O(`An error occurred: ${e.message}`)}})();})();
