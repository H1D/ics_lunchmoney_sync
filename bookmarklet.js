javascript: (()=>{(async()=>{const N=new Date,g=new Date(N);g.setDate(g.getDate()-50),document.getElementById("tw-cdn")||await new Promise(e=>{const n=Object.assign(document.createElement("script"),{id:"tw-cdn",src:"https://cdn.tailwindcss.com",onload:e});document.head.append(n)});const P=(e,n,a,p=!1)=>new Promise(u=>{const t=document.createElement("dialog");t.className="backdrop:bg-black/50 bg-white rounded-xl p-6 max-w-md w-[90%] shadow-2xl";const c=Object.assign(document.createElement("h2"),{textContent:e,className:"mb-4 text-xl font-semibold text-gray-900"}),h=Object.assign(document.createElement("div"),{innerHTML:n,className:"mb-5 text-sm leading-relaxed text-gray-600"}),r=Object.assign(document.createElement("input"),{type:p?"password":"text",placeholder:a,className:"w-full px-3 py-3 border-2 border-gray-200 rounded-lg text-sm mb-4 font-mono focus:outline-none focus:border-green-500"}),m=Object.assign(document.createElement("button"),{textContent:"Save",className:"bg-green-500 hover:bg-green-600 text-white px-5 py-2.5 rounded-lg text-sm font-medium transition",onclick:()=>{const i=r.value.trim();i&&(t.close(),t.remove(),u(i))}});r.addEventListener("keypress",i=>i.key==="Enter"&&m.click()),t.addEventListener("cancel",i=>{i.preventDefault()});const o=Object.assign(document.createElement("div"),{className:"flex gap-3 justify-end"});o.append(m),t.append(c,h,r,o),document.body.append(t),t.showModal(),queueMicrotask(()=>r.focus())}),f=(e,n)=>{const a=document.createElement("dialog");a.className="backdrop:bg-black/50 bg-white rounded-xl p-6 max-w-md w-[90%] shadow-2xl";const p=Object.assign(document.createElement("h2"),{textContent:e,className:"mb-4 text-xl font-semibold text-red-600"}),u=Object.assign(document.createElement("div"),{innerHTML:n,className:"mb-5 text-sm leading-relaxed text-gray-600"}),t=Object.assign(document.createElement("button"),{textContent:"Close",className:"bg-gray-500 hover:bg-gray-600 text-white px-5 py-2.5 rounded-lg text-sm font-medium transition",onclick:()=>{a.close(),a.remove()}}),c=Object.assign(document.createElement("div"),{className:"flex gap-3 justify-end"});c.append(t),a.append(p,u,c),document.body.append(a),a.showModal(),a.addEventListener("cancel",h=>{h.preventDefault(),a.close(),a.remove()})},T=async(e,n,a,p,u=!1)=>{const t=localStorage.getItem(e);if(t)return t;const c=await P(n,a,p,u);return localStorage.setItem(e,c),c},M=await T("LUNCHMONEY_ASSET_ID","üè¶ Lunch Money Asset ID",'Where to find your Asset ID:<br><br>1. Open <a href="https://my.lunchmoney.app/" target="_blank" class="text-green-600 hover:underline">Lunch Money</a><br>2. Click on your ICS/ABN AMRO account<br>3. The Asset ID is in the URL:<br><code class="bg-gray-100 px-2 py-1 rounded block mt-2">https://my.lunchmoney.app/transactions/...?<strong>asset=12345</strong></code><br>Use the number after <code class="bg-gray-100 px-1">asset=</code>',"Example: 12345"),C=await T("LUNCHMONEY_TOKEN","üîë Lunch Money API Token",'Where to get your token:<br><br>1. Open <a href="https://my.lunchmoney.app/developers" target="_blank" class="text-green-600 hover:underline">https://my.lunchmoney.app/developers</a><br>2. Click the <strong>"Request new access token"</strong> button<br>3. Copy the generated token',"Paste your API token",!0),d=e=>new Intl.DateTimeFormat("sv-SE").format(e),B=()=>{const e=document.createElement("dialog");e.className="backdrop:bg-black/80 bg-white rounded-xl p-8 max-w-lg w-[90%] shadow-2xl";const n=Object.assign(document.createElement("h2"),{textContent:"üîÑ Syncing Transactions",className:"mb-4 text-2xl font-semibold text-gray-900"}),a=Object.assign(document.createElement("div"),{textContent:"Initializing...",className:"mb-4 text-sm text-gray-600"}),p=Object.assign(document.createElement("div"),{className:"mb-4"}),u=Object.assign(document.createElement("div"),{className:"w-full bg-gray-200 rounded-full h-2"}),t=Object.assign(document.createElement("div"),{className:"bg-green-500 h-2 rounded-full transition-all duration-300",style:"width: 0%"});u.append(t),p.append(u);const c=Object.assign(document.createElement("div"),{className:"text-sm text-gray-500 space-y-1 mb-2"}),h=Object.assign(document.createElement("div"),{className:"text-xs text-gray-400 italic"});return e.append(n,a,p,c,h),document.body.append(e),e.showModal(),{dialog:e,updateStatus:r=>{a.textContent=r},updateProgress:r=>{t.style.width=`${r}%`},updateStats:(r,m)=>{c.innerHTML=`
          <div>üì• Fetched FROM ICS: <strong>${r}</strong> transactions</div>
          <div>üì§ Sent TO Lunch Money: <strong>${m}</strong> transactions</div>
        `},updateBatch:(r,m,o)=>{h.textContent=`Batch ${r} of ${m} ‚Ä¢ ${o}`},close:()=>{e.close(),e.remove()}}},_=e=>{const n=Object.assign(document.createElement("div"),{textContent:e,className:"fixed bottom-5 right-5 px-5 py-3 bg-gray-800 text-white rounded-lg z-[9999]"});document.body.append(n),setTimeout(()=>n.remove(),1e4)},I=decodeURIComponent(document.cookie.match(/XSRF-TOKEN=([^;]+)/)?.[1]??"");let k;try{const e=await fetch("/api/nl/sec/frontendservices/allaccountsv2",{headers:{"X-XSRF-TOKEN":I,Accept:"application/json"}});if(!e.ok){if(e.status===403){f("‚ùå Authentication Failed","Please make sure you're logged into ICS Cards and viewing your account page, then try again.<br><br>If you're not logged in, please log in first and navigate to your transactions page.");return}throw new Error(`Failed to fetch accounts: ${e.status}`)}const n=await e.json();if(k=Array.isArray(n)?n:[n],k.length===0){f("‚ùå No Accounts Found","No accounts were found. Please make sure you're logged in and have access to at least one account.");return}}catch(e){e.name==="TypeError"&&e.message.includes("fetch")?f("‚ùå Network Error","Failed to connect to ICS Cards. Please check your internet connection and try again."):f("‚ùå Error",`An error occurred: ${e.message}<br><br>Please make sure you're logged into ICS Cards and try again.`);return}const D=k[0].accountNumber;console.log(`Using account: ${D}`);const s=B();s.updateStatus(`Using account: ${D}`),s.updateProgress(0);let l=new Date(N),x=0,E=0;const F=Math.ceil((N-g)/(1e3*60*60*24));let j=0,b=0;const A=[];let y=new Date(N);for(;y>g;){const e=new Date(y);e.setDate(e.getDate()-30),e<g&&e.setTime(g.getTime()),A.push({from:new Date(e),until:new Date(y)}),y=new Date(e),y.setDate(y.getDate()-1)}const v=A.length;try{for(;l>g;){b++;const e=new Date(l);e.setDate(e.getDate()-30),e<g&&e.setTime(g.getTime());const n=Math.ceil((l-e)/(1e3*60*60*24));j+=n;const a=Math.min(j/F*100,95);s.updateProgress(a),s.updateStatus(`Fetching transactions from ${d(e)} to ${d(l)}...`),s.updateBatch(b,v,`${d(e)} ‚Üí ${d(l)}`);const u=`/api/nl/sec/frontendservices/transactionsv3/search?${new URLSearchParams({accountNumber:D,debitCredit:"DEBIT_AND_CREDIT",fromDate:d(e),untilDate:d(l)})}`,t=await fetch(u,{headers:{"X-XSRF-TOKEN":I,Accept:"application/json"}});if(!t.ok)throw new Error(`Bank API error: ${t.status} ${t.statusText}`);const c=await t.json();if(!Array.isArray(c)){console.error("Bank API error:",c);break}x+=c.length,s.updateStats(x,E);const h=`importedAt:${new Date().toISOString()}`;let r;try{r=(await(await fetch("https://api.lunchmoney.dev/v2/tags",{method:"POST",headers:{Authorization:`Bearer ${C}`,"Content-Type":"application/json"},body:JSON.stringify({name:h})})).json()).id}catch(o){console.error("Failed to create tag:",o)}const m=c.map(({transactionDate:o,description:i="",billingAmount:w,billingCurrency:$,sourceAmount:S,sourceCurrency:O,processingTime:L,batchNr:R,batchSequenceNr:U})=>{const H=Number(w),K=O&&O!==$?`Original: ${S} ${O}`:"";return{date:o,payee:i,amount:H,manual_account_id:Number(M),tag_ids:r?[r]:[],notes:K,external_id:`${o}-${L||"000000"}-${R}-${U}-${w}`,status:"unreviewed"}});if(m.length>0){s.updateStatus(`Sending ${m.length} transactions to Lunch Money...`),s.updateBatch(b,v,`Sending batch ${b}/${v}...`);const o=await fetch("https://api.lunchmoney.dev/v2/transactions",{method:"POST",headers:{Authorization:`Bearer ${C}`,"Content-Type":"application/json"},body:JSON.stringify({transactions:m,apply_rules:!0,skip_duplicates:!0})});if(!o.ok&&o.status!==201){const S=await o.text();throw new Error(`Lunch Money API error: ${o.status} ${o.statusText} - ${S.substring(0,200)}`)}const i=await o.json(),w=i.transactions?.length||0,$=i.skipped_duplicates?.length||0;E+=w,s.updateStats(x,E),s.updateBatch(b,v,`Batch ${b}/${v} complete (${w} new, ${$} skipped) ‚Ä¢ ${d(e)} ‚Üí ${d(l)}`),console.log(`Interval ${d(e)} ‚Äì ${d(l)}: ${w} inserted, ${$} skipped`)}l=new Date(e),l.setDate(l.getDate()-1)}s.updateProgress(100),s.updateStatus("‚úÖ Sync complete!"),s.updateStats(x,E),setTimeout(()=>{s.close(),_(`Sync complete. Fetched ${x} transactions, sent ${E}.`)},1500)}catch(e){console.error("Error syncing historical data:",e),typeof s<"u"&&s&&s.close(),f("‚ùå Sync Failed",`An error occurred while syncing transactions: ${e.message}<br><br>Please try again or check the browser console for more details.`)}})();})();
